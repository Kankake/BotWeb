<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Запись на пробное занятие | LEVITA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-light: #FDF5F9;
      --card-bg: #FFFFFF;
      --text-dark: #272727;
      --text-muted: #555555;
      --accent-gold: #D4AF37;
      --btn-hover: #b5942c;
      --card-radius: 12px;
      --gap: 12px;
    }
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    html, body { height: 100%; }
    body {
      background: var(--bg-light);
      font-family: 'Roboto', sans-serif;
      color: var(--text-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .contact-us p {
      margin: 0;
      font-size: 1rem;
      color: var(--text-dark);
    }
    /* Новые стили для закрепления блока снизу */
     .contact-us {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 400px;
      background: var(--card-bg);
      z-index: 100;
      padding: 4px 12px;     /* уже по высоте текста */
      display: flex;
      align-items: center;
      justify-content: space-between;
     }
.contact-us a {
      background: var(--text-muted) !important;
      color: #fff !important;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
    }
    .logo {
      display: block;
      max-width: 400px;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 0;
      z-index: 1;
    }

    .container {
  width: 100%;
  max-width: 400px;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2;
}

    .card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 20px; text-align: center; }
    h1 { font-size: 1.5rem; margin-bottom: 16px; color: var(--accent-gold); }
    p { font-size: 0.95rem; margin-bottom: 16px; line-height: 1.4; }
    .step { display: none; }
    .step.active { display: block; }
    
    .option.selected { background: var(--accent-gold); color: #fff; }

    .option {
      position: relative;
      display: block;
      padding: 12px;
      border: 2px solid var(--accent-gold);
      border-radius: 8px;
      cursor: pointer;
      background: var(--card-bg);
      color: var(--text-dark);
      font-weight: 500;
      margin-bottom: 12px;
    }

    .info-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  border: none;
  padding: 2px;
  cursor: pointer;
  width: 24px;
  height: 24px;
  min-width: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
}


.info-btn svg {
  width: 16px;
  height: 16px;
  color: var(--text-dark);
}

.info-btn:hover svg {
  color: var(--text-muted);
}

    .option span {
      flex: 1;
      padding-right: 8px;
    }

    .description {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: left;
      line-height: 1.4;
      background: #f9f9f9;
      padding: 0;
      border-radius: 6px;
      width: 100%;
      max-height: 0;
      overflow: hidden;
      transition: all 0.3s ease-in-out;
      opacity: 0;
      margin: 0;
    }

    .description.active {
      padding: 10px;
      max-height: 500px;
      opacity: 1;
      margin: 8px 0 4px;
    }

    .collapse-btn {
      background: var(--text-muted);
      border: none;
      border-radius: 4px;
      padding: 4px 6px;
      font-size: 0.8rem;
      color: var(--card-bg);
      justify-content: center;
      cursor: pointer;
      width: fit-content;
      white-space: nowrap;
      margin-left: auto;
      display: block;
      margin-top: 8px;
    }
    .collapse-btn:hover { background: var(--btn-hover); }

    input, button { font-family: 'Roboto', sans-serif; }
    input[type="text"], input[type="tel"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
    .buttons { display: flex; gap: 12px; justify-content: center; }
    button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 500; }
    .primary { background: var(--accent-gold); color: #fff; }
    .primary:hover { background: var(--btn-hover); }
    .secondary { background: var(--text-muted); color: #fff; }
    .secondary:hover { background: var(--text-muted); }
    ul { list-style: none; padding: 0; margin: 0 0 16px; text-align: left; }
    ul li { margin-bottom: 8px; }
    ul b { color: var(--accent-gold); }
  </style>
</head>
<body>
  <img src="assets/levita.png" class="logo">
  <div class="container">
    <div id="step-1" class="card step active">
      <h1>Добро пожаловать!</h1>
      <p>Мы сеть студий <strong>LEVITA г. Новороссийск</strong>. И мы рады, что вы выбрали нас! Нажмите далее для записи и получите первое занятие <strong>бесплатно</strong>.</p>
      <div class="buttons"><button class="primary" id="startBtn">Далее</button></div>
    </div>
    <div id="step-2" class="card step">
      <h1>Ваша цель</h1>
      <p>Исходя из выбора цели подберём подходящие направления.</p>
      <div class="options" id="options-goal">
        <div class="option" data-val="Укрепить тело">Укрепить тело</div>
        <div class="option" data-val="Улучшить мобильность суставов">Улучшить мобильность суставов</div>
        <div class="option" data-val="Поправить осанку">Поправить осанку</div>
        <div class="option" data-val="Убрать лишний вес">Убрать лишний вес</div>
        <div class="option" data-val="Хочу танцевать">Хочу танцевать</div>
        <div class="option" id="chooseSelf" data-val="Самостоятельный выбор">Хочу выбрать направление</div>
      </div>
      <div class="buttons">
        <button class="secondary" id="back2">Назад</button>
        <button class="primary" id="next2">Далее</button>
      </div>
    </div>
    <div id="step-3" class="card step">
      <h1>Выберите направление для первого посещения</h1>
      <div class="options" id="options-dir"></div>
      <div class="buttons">
        <button class="secondary" id="back3">Назад</button>
        <button class="primary" id="next3">Далее</button>
      </div>
    </div>
    <div id="step-4" class="card step">
      <h1>Выберите удобную студию</h1>
      <div class="options" id="options-address">
        <div class="option" data-val="Свободы 6">Свободы 6 (Центральный)</div>
        <div class="option" data-val="Видова 210Д">Видова 210Д (Приморский)</div>
        <div class="option" data-val="Дзержинского 211/2">Дзержинского 211/2 (Южный)</div>
      </div>
      <div class="buttons">
        <button class="secondary" id="back4">Назад</button>
        <button class="primary" id="next4">Далее</button>
      </div>
    </div>
    <div id="step-5" class="card step">
      <h1>Доступные датя для записи</h1>
      <div class="options" id="options-slots"></div>
      <div class="buttons">
        <button class="secondary" id="back5">Назад</button>
        <button class="primary" id="next5">Далее</button>
      </div>
      <div class="buttons" style="margin-top: 8px;">
        <button class="more" id="weekBtn">Больше</button>
      </div>
    </div>
    <div id="step-7" class="card step">
      <h1>Проверьте данные</h1>
      <ul>
        <li><b>Цель:</b> <span id="sum-goal"></span></li>
        <li><b>Направление:</b> <span id="sum-dir"></span></li>
        <li><b>Студия:</b> <span id="sum-address"></span></li>
        <li><b>Слот:</b> <span id="sum-slot"></span></li>
      </ul>
      <div class="buttons">
        <button class="secondary" id="back7">Назад</button>
        <button class="primary" id="submit7">Отправить</button>
      </div>
    </div>
    <div id="step-8" class="card step">
      <h1>Готово!</h1>
      <p>Спасибо! Подтвердите свою запись в телеграмме, отправив ваше имя и номер телефона.<br>До скорых встреч!</p>
      <div class="buttons"><button class="primary" id="thankBtn">Закрыть</button></div>
    </div>
  </div>
<div class="card contact-us">
      <p>Связаться с нами:</p>
      <div class="buttons">
        <a href="https://t.me/SerenkoKonstantin" target="_blank" class="secondary">Телеграм</a>
        <a href="https://clck.ru/3MFEqd" target="_blank" class="secondary">WhatsApp</a>
      </div>
    </div>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const steps = ['step-1','step-2','step-3','step-4','step-5','step-7','step-8'];
    let data = {};
    const show = id => {
      steps.forEach(s => document.getElementById(s).classList.remove('active'));
      document.getElementById(id).classList.add('active');
    };
    // Step1
    document.getElementById('startBtn').addEventListener('click', () => show('step-2'));
    // Step2
    document.querySelectorAll('#options-goal .option').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('#options-goal .option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
        data.goal = el.dataset.val;
      });
    });
    document.getElementById('back2').addEventListener('click', () => show('step-1'));
    document.getElementById('next2').addEventListener('click', () => data.goal && (populateDirs(), show('step-3')));
    // Step3
    document.getElementById('back3').addEventListener('click', () => show('step-2'));
    document.getElementById('next3').addEventListener('click', () => data.direction && show('step-4'));
    // Step4
    document.querySelectorAll('#options-address .option').forEach(el => {
      el.addEventListener('click', () => {
        document.querySelectorAll('#options-address .option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
        data.address = el.dataset.val;
      });
    });
    document.getElementById('back4').addEventListener('click', () => show('step-3'));
    document.getElementById('next4').addEventListener('click', () => fetchAndShowSlots());
    // Step5
    document.getElementById('back5').addEventListener('click', () => show('step-4'));
    document.getElementById('next5').addEventListener('click', () => {
      document.getElementById('sum-goal').textContent = data.goal;
      document.getElementById('sum-dir').textContent = data.direction;
      document.getElementById('sum-address').textContent = data.address;
      document.getElementById('sum-slot').textContent = data.slot;
      show('step-7');
    });
    // Step7
    document.getElementById('back7').addEventListener('click', () => show('step-5'));
    
    document.getElementById('submit7').addEventListener('click', async () => {
      const resp = await fetch('/submit', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telegram_id: tg.initDataUnsafe.user.id, ...data }) });
      const res = await resp.json();
      if (res.ok) show('step-8'); else alert('Ошибка отправки');
    });
    document.getElementById('thankBtn').addEventListener('click', () => tg.close());

    const directionDescriptions = {
      'Классическая хореография': 'Почувствуйте себя настоящей балериной, занимаясь под классическую музыку. Это мягкая тренировка адаптированная для любителей, которая гармонично прорабатывает все тело. Ваши движения станут пластичными, осанка — королевской. Уже после первой тренировки вы почувствуете, как расправляются плечи. С накопительным эффектом — чем дольше занимаетесь, тем лучше сохраняется красивая осанка.',
      'Партерная хореография': 'Эта тренировка начинается на полу, где прорабатывается выворотность, как у профессиональных балерин. После работы в партере встать к станку будет легче. Отлично подходит для развития гибкости и координации.',
      'Барре': 'Энергичная тренировка у станка под современную музыку, направленная на развитие силы и рельефа. Основной акцент — на ягодицы и ноги: они станут подтянутыми и красивыми. За счёт ритмичности занятия вы получаете как силовую нагрузку, так и улучшение выносливости.',
      'Боди-Балет': 'Кардио с элементами силовых упражнений. Отличный выбор, если ваша цель — похудение! Процесс жиросжигания идёт активно, мышцы подтягиваются, а тело становится стройнее. Вы укрепите все основные группы мышц, улучшите выносливость и получите заряд энергии.',
      'Балетная подкачка': 'Самая интенсивная тренировка в формате круговой программы. Поэтапно задействуем все мышцы, создавая комплексную нагрузку. Результат — мощное укрепление и тонус всего тела.',
      'Растяжка': 'Занятие для полноценной проработки тела без акцента на шпагат. Мы мягко тянем все мышцы — от шеи до стоп, уделяя внимание гибкости и улучшению подвижности суставов. Вы почувствуете лёгкость и расслабление в теле уже после первой тренировки.',
      'Пилатес': 'Это дыхательная практика, где каждая минута тренировки посвящена правильному дыханию и проработке глубоких мышц, поддерживающих осанку и внутренние органы. Упражнения укрепляют всё тело, улучшая oсaнку, но за счёт деликатного подхода тренировка подходит всем уровням подготовки.'
    };

  // Обновленная функция populateDirs: исправлен показ описания, подсветка опции и кнопка скрыть
function populateDirs(showAll = false) {
  const cont = document.getElementById('options-dir');
  cont.innerHTML = '';
  // Включаем возможность скролла
  cont.style.maxHeight = '60vh';
  cont.style.overflowY = 'auto';

  const map = {
    'Укрепить тело': ['Барре', 'Боди-Балет'],
    'Улучшить мобильность суставов': ['Растяжка'],
    'Поправить осанку': ['Классическая хореография', 'Пилатес'],
    'Убрать лишний вес': ['Барре', 'Боди-Балет'],
    'Хочу танцевать': ['Классическая хореография']
  };
  const list = showAll ? Object.keys(directionDescriptions) : (map[data.goal] || []);

  list.forEach(val => {
    const d = document.createElement('div');
    d.className = 'option';
    d.dataset.val = val;
    if (data.direction === val) d.classList.add('selected');

    // Вставляем HTML перенесенный в template для расширения
    d.innerHTML = `
      <span>${val}</span>
      <button class="info-btn" title="Подробнее">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2"/>
          <path d="M12 16V12M12 8H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
      <div class="description">${directionDescriptions[val] || ''}</div>
      <button class="collapse-btn" title="Скрыть">Скрыть</button>
    `;

    const infoBtn = d.querySelector('.info-btn');
    const desc = d.querySelector('.description');
    const collapseBtn = d.querySelector('.collapse-btn');
    // Скрываем описание и кнопку
    desc.classList.remove('active');
    collapseBtn.style.display = 'none';

    // Клик по info-btn — показываем описание и кнопку скрыть
    infoBtn.addEventListener('click', e => {
      e.stopPropagation();
      desc.classList.add('active');
      collapseBtn.style.display = 'inline-block';
      // Прокрутить к описанию
      desc.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });

    // Кнопка скрыть — прячет описание и себя, возвращает info-btn
    collapseBtn.addEventListener('click', e => {
      e.stopPropagation();
      desc.classList.remove('active');
      collapseBtn.style.display = 'none';
    });

    // Клик по опции — выделение
    d.addEventListener('click', e => {
      if (e.target.closest('.info-btn') || e.target.closest('.collapse-btn')) return;
      document.querySelectorAll('#options-dir .option').forEach(o => o.classList.remove('selected'));
      d.classList.add('selected');
      data.direction = val;
    });

    cont.appendChild(d);
  });
}

// Переназначение кнопки "Хочу выбрать направление"
document.getElementById('chooseSelf').addEventListener('click', () => {
  data.goal = 'Самостоятельный выбор';
  populateDirs(true);
  show('step-3');
});

// Инициализация при переходе из шага 2
document.getElementById('next2').addEventListener('click', () => {
  if (data.goal) {
    populateDirs(false);
    show('step-3');
  }
});

const weekBtn = document.getElementById('weekBtn');

// Добавляем обработчик клика, чтобы показать расписание на неделю
weekBtn.addEventListener('click', () => {
  fetchAndShowSlots(7); // теперь показываем 7 дней
});

async function fetchAndShowSlots(days = 3) {
  try {
    const response = await fetch('data/schedules.json');
    if (!response.ok) throw new Error('Ошибка сети');

    // schedules.json — объект с ключами-адресами
    const schedulesObj = await response.json();
    const allSlots = schedulesObj[data.address] || [];

    const today = new Date();
    const showDays = [];
    for (let i = 0; i < days; i++) {
      const d = new Date(today);
      d.setDate(d.getDate() + i);
      showDays.push(d.toISOString().slice(0, 10));
    }

    const cont = document.getElementById('options-slots');
    cont.innerHTML = '';
    // Устанавливаем ограничения и скролл, если контент превышает
    cont.style.maxHeight = '300px';
    cont.style.overflowY = 'auto';

    showDays.forEach(day => {
      const dateStr = new Date(day).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
      allSlots
        .filter(slot => slot.direction.trim() === data.direction.trim() && slot.date === day)
        .forEach(s => {
          const b = document.createElement('div');
          b.className = 'option';
          b.textContent = `${dateStr} — ${s.time}`;
          b.onclick = () => {
            document.querySelectorAll('#options-slots .option').forEach(o => o.classList.remove('selected'));
            b.classList.add('selected');
            data.slot = `${day}, ${s.time}`;
          };
          cont.appendChild(b);
        });
    });

    if (!cont.hasChildNodes()) {
      alert(`Нет доступных слотов на ближайшие ${days} дней`);
    } else {
      show('step-5');
    }
  } catch (error) {
    console.error('Ошибка загрузки расписания:', error);
    alert('Не удалось загрузить расписание');
  }
}
  </script>
</body>
</html>
